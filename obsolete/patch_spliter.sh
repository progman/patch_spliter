#!/bin/bash
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# 0.0.2
# Alexey Potehin http://www.gnuplanet.ru/doc/cv
#
# git clone git://github.com/progman/patch_spliter
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
# check depends
function check_prog()
{
	for i in ${1};
	do
		if [ "$(which ${i})" == "" ];
		then
			echo "FATAL: you must install \"${i}\"...";
			return 1;
		fi
	done

	return 0;
}
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
function main()
{
	check_prog "echo cat wc mktemp grep sed tail head printf rm";
	if [ "${?}" != "0" ];
	then
		return 1;
	fi


	if [ ! -e "${1}" ];
	then
		echo "example: ${0} file.patch";
		return 1;
	fi

	local TOTAL_LINE=$(cat ${1} | wc -l);

	if [ "${TOTAL_LINE}" == "0" ];
	then
		echo "ERROR: file is empty";
		return 1;
	fi

	(( TOTAL_LINE++ ));

	local TMP;
	TMP=$(mktemp);
	grep -n diff "${1}" | sed -e 's/\:.*//g' >> "${TMP}";
	echo "${TOTAL_LINE}" >> "${TMP}";

#	cat "${TMP}";

	local COUNT=1;

	local FLAG_FIRST='1';

	local A;
	local B;
	local C;
	local D;

	while read -r B;
	do
		if [ "${FLAG_FIRST}" == "1" ];
		then
			if [ "${B}" != "1" ];
			then
				echo "ERROR: strange file";
				return 1;
			fi
			FLAG_FIRST='0';
			A="${B}";
			continue;
		fi


		(( C = B - A + 0 ));

		(( D = TOTAL_LINE - A + 0 ));

#		echo "A: ${A}";
#		echo "B: ${B}";
#		echo "C: ${C}";
#		echo "D: ${D}";

		tail -n ${D} "${1}" | head -n ${C} > ${1}-$(printf "%04u" ${COUNT}).patch;

		(( COUNT++ ));

#		break;

		A="${B}";


	done < "${TMP}";


	rm -rf "${TMP}" &> /dev/null < /dev/null;


	return 0;
}
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
main "${@}";

exit "${?}";
#-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------#
